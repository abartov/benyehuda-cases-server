= f.inputs :name => I18n.t('task_section.general') do
  = f.input :name, :required => true, :label => I18n.t('gettext.name'), :input_html => {:class => 'span-13'}
  - if defined? newkind
    = f.input :kind, :as => :select, :collection => task_kinds_for_select, :required => true, :label => I18n.t('gettext.kind'), :selected => newkind
  - else
    = f.input :kind, :as => :select, :collection => task_kinds_for_select, :required => true, :label => I18n.t('gettext.kind')
  - if current_user && current_user.is_admin?
    = link_to I18n.t('gettext.manage_kinds'), "#", :id => "manage_kinds"
  = f.input :genre, :as => :select, :collection => Task.genres.keys.map{|g| [g, g]}, :label => 'סוגה'
  = f.input :independent, :as => :boolean, :label => 'אפשר להעלות בנפרד?'
  = f.input :include_images, :as => :boolean, :label => 'מותר להעלות תמונות?'
  = f.input :source, :label => 'פרטי מהדורה (מהדורה [אם יש], עיר: מו"ל, שנה)', :input_html => {:class => 'span-13'}
  - if current_user && current_user.is_admin?
    %h4= t('.teams')
    %ol#task_teams_list
      - @task.task_teams.each do |task_team|
        %li{id: "task_team_#{task_team.id}"}
          = link_to task_team.team.name, team_path(task_team.team)
          = link_to t(:remove), task_team_path(task_team), method: :delete, remote: true, data: {confirm: t(:are_you_sure)}
    = t(:add)
    = select_tag :add_team_id, options_from_collection_for_select(Team.where.not(id: @task.teams.pluck(:id)).order(:name), :id, :name), include_blank: 'בחר צוות'
    - if @task.persisted?
      = button_tag t(:perform_add), id: "add_team", type: :button
    %br

    = link_to t('.manage_teams'), teams_path
  %p
  = f.collection_select :project_id, Project.where(status: 'פעיל').order(:name), :id, :name, {include_blank: 'שיוך למיזם', selected: @task.project_id}
  /= f.input :project, as: :select, collection: Project.where(status: 'פעיל'), selected: @task.project, label: 'מיזם'
  - if current_user && current_user.is_admin?
    = link_to 'ניהול מיזמים', projects_path
  /= f.input :difficulty, :as => :select, :collection => task_difficulties_for_select, :required => true, :label => I18n.t('gettext.difficulty')
  /= f.input :priority, :as => :select, :collection => task_priorities_for_select, :required => true, :label => I18n.t('gettext.priority')
  = f.input :full_nikkud, :as => :boolean, :label => I18n.t('gettext.full_nikkud')
  = f.input :hours, :label => I18n.t('gettext.hours_spent')+' '

:javascript
  var index_html = '#{escape_javascript(render(:template => "admin/task_kinds/index"))}';
  $(function(){
    $("#manage_kinds").click(function(){
      $.modal(
        index_html,
        {
          close: true,
          opacity: 80,
          overlayCss: {backgroundColor:"black"},
          containerCss:{
            borderColor:"#fff",
            padding:10,
            width:300
          },
          overlayClose:true
        }
      );
      return false;
    });
  });
  $(document).ready(function() {
    if($('#task_kind_id').val() == '') {
      $('#task_kind_id').val('1'); // default to typing
    }
    persisted = #{@task.persisted? ? 'true' : 'false'};
    if (persisted) {
      $("#add_team").click(function() {
        var teamId = $("#add_team_id").val();
        if (!teamId) return;
        $.ajax({
          url: "#{task_teams_path}",
          type: "POST",
          data: {task_team: {team_id: teamId, task_id: #{@task.id}}, add_team_id: true},
          dataType: "json",
          success: function(data) {
            function escapeHtml(str) {
              return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
            }
            var newItem = '<li id="task_team_' + data.task_team_id + '">' +
              '<a href="/teams/' + data.team_id + '">' + escapeHtml(data.team_name) + '</a> ' +
              '<a data-confirm="#{j(t(:are_you_sure))}" data-method="delete" href="/task_teams/' + data.task_team_id + '" rel="nofollow" data-remote="true">#{j(t(:remove))}</a>' +
              '</li>';
            $('#task_teams_list').append(newItem);
            $('#add_team_id option[value="' + data.team_id + '"]').remove();
            $('#add_team_id').val('');
          }
        });
      });
    }
  });
