= set_tab :dashboard, false

!= link_to _("back to dashboard"), dashboard_path

.task-title
  %b
    = _("Task title")+": "
  = @task.name
  - when_admin do
    %a.purple-button.gradient{ :href => edit_admin_task_path(@task) }
      %span
        != _("Edit")
    %a.purple-button.gradient{ href: split_task_path(@task)}
      %span!= "פיצול"
    %a.purple-button.gradient{ href: classify_scans_path(@task)}
      %span!= "סיווג סריקות"
.box
  .boxhead
    %b
      = _("Task details")
  .boxcontainer
    != render(:partial => "description")
    %br
    .midtitle
      .boxbody
        = _("Attached documents")
    .boxbody
      %table
        %tr
          %td.vtop
            %b
              = _("Instructions")+": "
          %td.instructions
            != auto_link(@task.instructions)
      - if @task.kind.name == 'הגהה'
        %a.purple-button.gradient{ :href => 'https://benyehuda.org/page/proofreading', :target => '_new'}
          %span
            = "הנחיות הגהה קבועות"
      - else
        %a.purple-button.gradient{ :href => 'https://benyehuda.org/page/typing', :target => '_new'}
          %span
            = _("Standard instructions")
      %br
      %br

      != render(:partial => "documents", :locals => {:documents => @task.documents})
      != render(:partial => "new_document")

-#- @task.task_properties.visible_for(current_user).each do |p|
-#  %p
-#    %strong= "#{p.property.title}:"
-#    != property_value(p)
- if @task.assignee?(current_user)
  != render(:partial => "assignee_events")
%br
%hr
!= render(:partial => "comments/index", :locals => {:comments => @comments})
%hr
- if @task.editor?(current_user) or current_user.is_editor?
  %h3= _("Hours spent")
  %p= @task.hours
  != render(:partial => "editor_events")
%br
%br
- when_editor_or_admin do
  - if @task.task_idle_reminders.any?
    .box
      .boxhead
        %b= I18n.t('tasks.idle_reminders_sent')
      .boxcontainer
        .boxbody
          %table.data-table
            %thead
              %tr
                %th= I18n.t('tasks.date_sent')
                %th= I18n.t('tasks.recipient')
                %th= I18n.t('tasks.days_ago')
            %tbody
              - @task.task_idle_reminders.order(sent_at: :desc).each do |reminder|
                %tr
                  %td= reminder.sent_at.strftime('%d/%m/%Y %H:%M')
                  %td= reminder.user.name
                  %td= I18n.t('tasks.days_ago_value', count: ((Time.zone.now - reminder.sent_at) / 1.day).round)
          %br
  .box
    != render(:partial => "audits/index")

#image-crop-modal{ :title => I18n.t('documents.crop_image'), :style => "display:none;" }
  .crop-container{ :style => "overflow: hidden;" }
    %img#crop-image{ :style => "display: block; max-width: 100%;" }
  .crop-buttons{ :style => "margin-top: 10px; text-align: center;" }
    %button#download-cropped.purple-button.gradient
      %span= I18n.t('documents.download_cropped_image')
    %button#cancel-crop.purple-button.gradient{ :style => "margin-left: 10px;" }
      %span= I18n.t('common.cancel')

%link{ :href => "https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css", :rel => "stylesheet" }
%script{ :src => "https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js" }

:javascript
  var cropper;
  var currentImageName;

  jQuery(document).ready(function() {
    // Maximize modal size - use as much viewport as possible
    // Use native innerWidth/innerHeight to get actual viewport, not document size
    var viewportWidth = window.innerWidth;
    var viewportHeight = window.innerHeight;
    var modalWidth = Math.floor(viewportWidth * 0.95);
    var modalHeight = Math.floor(viewportHeight * 0.90);

    jQuery('#image-crop-modal').dialog({
      draggable: true,
      modal: true,
      resizable: true,
      autoOpen: false,
      position: { my: 'center', at: 'center', of: window },
      width: modalWidth,
      maxHeight: modalHeight,
      open: function() {
        // Force dialog to be centered in viewport, not page
        var dialog = jQuery(this).parent('.ui-dialog');
        var scrollTop = jQuery(window).scrollTop();
        var scrollLeft = jQuery(window).scrollLeft();
        var viewportHeight = window.innerHeight;
        var viewportWidth = window.innerWidth;
        var dialogHeight = dialog.outerHeight();
        var dialogWidth = dialog.outerWidth();

        // Center in viewport
        var top = scrollTop + (viewportHeight - dialogHeight) / 2;
        var left = scrollLeft + (viewportWidth - dialogWidth) / 2;

        dialog.css({
          position: 'fixed',
          top: '50%',
          left: '50%',
          transform: 'translate(-50%, -50%)',
          margin: 0
        });
      },
      close: function() {
        if (cropper) {
          cropper.destroy();
          cropper = null;
        }
      }
    });

    jQuery(document).on('click', '.crop-image-link', function(e) {
      e.preventDefault();
      var imageUrl = jQuery(this).data('image-url');
      currentImageName = jQuery(this).data('image-name');

      jQuery('#crop-image').attr('src', imageUrl);
      jQuery('#image-crop-modal').dialog('open');

      setTimeout(function() {
        if (cropper) {
          cropper.destroy();
        }
        var image = document.getElementById('crop-image');

        // Use the maxHeight we set, not the current dialog height
        // Use native innerHeight to get actual viewport, not document height
        var viewportHeight = window.innerHeight;
        var targetModalHeight = Math.floor(viewportHeight * 0.90);

        // Get actual title bar height
        var titleBar = jQuery('#image-crop-modal').prev('.ui-dialog-titlebar');
        var titleBarHeight = titleBar.outerHeight(true) || 40;

        // Get buttons height
        var buttonsHeight = jQuery('.crop-buttons').outerHeight(true) || 50;

        // Account for jQuery UI dialog padding/margins (typically 10-20px)
        var dialogOverhead = 30;

        // Calculate available height from viewport, not from dialog element
        var availableHeight = targetModalHeight - titleBarHeight - buttonsHeight - dialogOverhead;

        console.log('Viewport height:', viewportHeight);
        console.log('Target modal height (75%):', targetModalHeight);
        console.log('Title bar height:', titleBarHeight);
        console.log('Buttons height:', buttonsHeight);
        console.log('Dialog overhead:', dialogOverhead);
        console.log('Available height for image:', availableHeight);

        // Set container to exact calculated height
        jQuery('.crop-container').css({
          'height': availableHeight + 'px',
          'max-height': availableHeight + 'px',
          'overflow': 'hidden'
        });

        cropper = new Cropper(image, {
          aspectRatio: NaN,
          viewMode: 1,
          background: false,
          autoCropArea: 0.8,
          responsive: true,
          restore: true,
          checkCrossOrigin: false
        });
      }, 500);
    });

    jQuery('#download-cropped').click(function() {
      console.log('Download button clicked');
      if (!cropper) {
        console.error('Cropper not initialized');
        return;
      }
      console.log('Cropper exists:', cropper);

      var canvas = cropper.getCroppedCanvas();
      console.log('Canvas obtained:', canvas);

      if (!canvas) {
        console.error('getCroppedCanvas() returned null/undefined');
        return;
      }

      // Determine format from filename extension
      var nameParts = currentImageName.split('.');
      var extension = (nameParts.length > 1 ? nameParts[nameParts.length - 1] : 'png').toLowerCase();
      var baseName = nameParts.slice(0, -1).join('.') || 'cropped';
      console.log('Image extension:', extension);

      // Use toDataURL for better browser compatibility with downloads
      var mimeType = 'image/' + (extension === 'jpg' ? 'jpeg' : extension);
      console.log('Converting canvas to data URL with MIME type:', mimeType);

      var dataURL = canvas.toDataURL(mimeType);
      console.log('Data URL created, length:', dataURL.length);

      var a = document.createElement('a');
      a.href = dataURL;
      a.download = baseName + '_cropped.' + extension;
      console.log('Download filename:', a.download);
      console.log('Anchor href (first 100 chars):', a.href.substring(0, 100));
      console.log('Anchor href length:', a.href.length);

      document.body.appendChild(a);
      console.log('After appending to body, href (first 100 chars):', a.href.substring(0, 100));
      console.log('Triggering click on download link');
      a.click();
      console.log('Download triggered');

      // Clean up
      document.body.removeChild(a);
      console.log('Cleanup completed');
    });

    jQuery('#cancel-crop').click(function() {
      jQuery('#image-crop-modal').dialog('close');
    });
  });
